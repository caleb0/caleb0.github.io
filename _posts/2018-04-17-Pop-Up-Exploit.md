---
layout: post
title: Undisclosed "pop-up" macro exploit
---

<div style="width:100%;height:0px;position:relative;padding-bottom:56.250%;"><iframe src="https://streamable.com/s/mg3dx/olzlsd" frameborder="0" width="100%" height="100%" allowfullscreen style="width:100%;height:100%;position:absolute;left:0px;top:0px;overflow:hidden;"></iframe></div>

Dear Friends,

A few months ago, during my macro malware research, I came across this very interesting article [from ZScaler](https://www.zscaler.com/blogs/research/malicious-rtf-document-leading-netwiredrc-and-quasar-rat), that sheds light on a new type of noisy yet effective macro exploit method being used in the wild. However, the article did not disclose any technical details for the exploit and was left scratching my head. After many hours of experimentation, I stumbled upon the (undisclosed?, unpatched) obscure technique that embeds macro enabled worksheets to this "persistant pop-up" effect. 

## The .XLA and .XLAM file format
This exploit revolves around the strange behaviour of .xlam and .xla macro notification methods. The .xlam and .xla file format is a macro-enabled add-in file format designed to transfer macros from worksheet to worksheet. Whereas normal Excel workbooks will open a .xls or .xlsm workbook with a "Enable Content" bar, .xla and .xlam file formats open with a thread-blocking prompt window. I have yet to determine what specifically causes the different pop-up prompt, as I'm sure that I've seen this type of prompt on regular .doc's before. 

![XLAM vs XLS](https://i.imgur.com/WolYeAr.png)

Now, by combining this document with [the \objupdate method made popular by CVE-2017-0199](https://www.mdsec.co.uk/2017/04/exploiting-cve-2017-0199-hta-handler-vulnerability/), we can make a new .doc or .rtf that embeds a number of these addon files that will persistantly pause the Excel application until the user enables macros.

By embedding the object, we are displayed with a lovely embedded worksheet.

![Embed](https://i.imgur.com/gz0yqKW.png)

To make this less suspicious, we can edit the style of the worksheet to not display the grid. To achieve the persistant effect, we can copy and paste this object an arbritary number of times. 

![Hide gridlines](https://i.imgur.com/GIh2plM.png)

Then, saving as a .rtf document, we can go into our favourite text editor and manually insert the "\objupdate" control keyword into each object. Optionally, the .rtf can be renamed to .doc.

![Hide gridlines](https://i.imgur.com/vg3V6s1.png)

[Clearly the method itself is undetected by all AV's](http://viruscheckmate.com/id/hGQtwZVjM64k) with the Nano detection coming from the detection of the macro within the embedded doc. The technique can be further improved by adding a registry edit within the .xlam file that enables all macros without prompts, so once the victim enables the macro, none of the other prompts will show. 

## Prevention
My proposed solution to this is to remove the thread-blocking prompt and instead just have an "Enable Content" bar for all files. I might reach out to Microsoft and see if they have anything to say for this. 
